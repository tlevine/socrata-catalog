---
title: What file formats are on the data portals?
---
```{r configure, echo = F}
opts_chunk$set(fig.width=10, fig.height=5, dpi = 42 * 5)
```

While [at Socrata's office]() on Friday,
I learned of the [`/data.json`](https://data.oregon.gov/data.json) endpoint.
It contains an entry for each [dataset](),
uploaded by the data publisher; it doesn't contain all of the other
views that are based on these source datasets.
And it has [this format](http://project-open-data.github.io/schema/).

## How many datasets?
Socrata portals have [50,000 different views](), but only
`r nrow(datasets)` are original datasets, with a median of
`r median(table(datasets$portal))` datasets per portal.

```{r portal-counts, fig.width = 10, fig.height = 15}
p.portal.counts
```

This is much lower than my [earlier figure]()
that included [derived views]() (map, charts, &c.) and
[federated data]() (duplicates).

I'd like some time to compare the within-portal counts of original datasets
and derived datasets. But not right now.

## My curiousity about file formats
I've recently become curious about what formats the datasets come from. When
tabular data get loaded into a Socrata data portal, they get converted to a
tabular representation within the portal software. From that, they get converted
to a range of different tabular formats.

The Socrata data portal doesn't explicitly store the source format because of
how the import process works. Most of the data [probably come from Excel](scraperwiki),
and the data that aren't from Excel typically come from inside of a government
network where policies would make it inconvenient to expose the database to the
world. Because of this, Socrata doesn't query database servers. Instead, data
publishers write middlemen that act as both database clients and Socrata clients.
They query the database and then make [web requests](api)
to the Socrata portal.

## `/data.json` contains file format information
The `/data.json` endpoint contains a file format field per the Project Open Data
schema. This refers to the format of the data as served from the Socrata portal,
not the format it was stored in before it got to the Socrata portal. But this
still tells us something about the source file formats.

People sometimes upload things that Socrata doesn't interpret as tables. PDFs are
a major example. Other times, people upload or [link to]()
files that could be tables but don't specify that they are tables. Here are the
different types.

Data formats are represented in two fields, `format` and `distribution`. `distribution`
seems to contain all of the different available formats. If the data are imported as
tabular data, it contains CSV, JSON, XML, &c., all served from the Socrata site.
And if the data are external links, it will contain a few external links, still
specifying the file types. The `format` field contains one of the formats that are
specified in the `distribution` field. I think it's just the first of the formats.
For the present analysis, I'm using the `format` field.

(image of counts across portal)

And here are some of the main types by portal.

```{r all-formats, fig.width = 10, fig.height = 15}
p.all
```

`csv` mostly refers
to data that Socrata represents as a table; this is the sort of data that Socrata
can convert to a range of different tabular data formats.
It is also my [preferred file format](http://csvsoundsystem.com).

The other formats appear to be external links.

## CSV
Most datasets are CSV (`r sum(na.omit(datasets$format == 'csv'))' of `r nrow(datasets`).
I was curious as to how this varies by portal and over time, and the following image
addresses that. It contains one plot per data portal. The x-axis of each plot is the date,
the y-axis is the proportion[^proportion] of datasets that are tabular (CSV), and the
width of the line is the number of datasets on the portal.

For example, if there were 100 datasets on a portal in June 2011 and 80 were CSV, the
line would be near the top of the graph and quite skinny at June 2011.

```{r csv-cum-facet, fig.width = 20, fig.height = 10}
p.csv.cum.facet
```

## Some interesting portals
Some portals have only CSV data (like `data.medicare.gov`), but most contain
other data. I am curious both as to what other data formats they have and what
prompted the shifts in dataset format.

Missouri mostly has PDFs.

```{r mo}
p.data.mo.gov
```

Lehman College has some zipped files.

```{r lehman}
p.bronx.lehman.cuny.edu
```

San Francisco has a lot of CSVs, a lot of externally linked zip files,
and a lot of externally linked files of unknown format.

```{r sf}
p.data.sfgov.org
```

```{r hawaii}
p.data.hawaii.gov
```

## Determination of external link file formats
It looks like the format of external links is determined by the file name.
Here are some examples.

* a
* b
* c

## CSV, zip and octet-stream

```{r csv-pdf-cum-facet, fig.width = 20, fig.height = 10}
p.csv.pdf.cum.facet
```

## Dates

## More study of file formats
This got me thinking about other ways of studying file formats.

### The attribution field
Socrata's SODA 1 API [contains]() an `attribution` field, which references the URL from
which the dataset was taken. (I presume that this is entered manually.) This would be one
way of figuring out the source format, or at least some related information about the source.

### Externally linked CSVs
Not all of the CSV-formatted datasets necessarily come from Socrata; some might be links
to external CSV files. There is enough information in `/data.json` to determine which of
these categories a CSV dataset falls into.

### Determining the formats of external links
It looks to me like the format type of external links is determined based on the file
extension of the URL; `octet-stream` datasets seem to correspond to URLs without file
extensions or with file extensions like `aspx` that don't clearly correspond to a
particular file types. One could determine the formats of these datasets by
downloading the files.

## Footnotes

[^proportion]: It's actually a tad bit more complicated than that. These dates are the
    creation dates of the datasets that are available today; I do not know about datasets
    that were historically on the portal and have since been deleted.
